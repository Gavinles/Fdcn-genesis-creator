# Mindpath Vercel Deployment Guide

This guide explains how to deploy the Mindpath application (generated by `mindpath-genesis.sh`) to Vercel and other cloud platforms.

## Architecture Overview

The Mindpath application consists of two main components:

1. **Frontend**: Next.js application (can be deployed to Vercel)
2. **Backend**: Flask + Flask-SocketIO server with WebSocket support (requires persistent connection hosting)

## Important: Backend Deployment Limitation

⚠️ **Vercel cannot host the Mindpath backend** because:
- Vercel serverless functions have a 10-second execution timeout
- Flask-SocketIO requires persistent WebSocket connections
- The backend needs to maintain stateful connections with clients

**Solution**: Deploy the backend separately on a platform that supports persistent connections.

## Deployment Options

### Option 1: Vercel (Frontend) + Render.com (Backend) ✅ RECOMMENDED

This is the recommended approach as it leverages Vercel's excellent Next.js hosting while using Render for the WebSocket backend.

#### Step 1: Generate the Mindpath Application

```bash
# Run the genesis script to create the application structure
./mindpath-genesis.sh
```

This creates `backend/` and `frontend/` directories with a complete application.

#### Step 2: Deploy Backend to Render.com

1. Push your repository to GitHub (if not already done)

2. Go to [Render.com](https://render.com) and sign in

3. Click "New +" → "Blueprint"

4. Connect your repository

5. Use the `render-mindpath.yaml` configuration file

6. Deploy the service

7. Copy the backend URL (e.g., `https://mindpath-backend.onrender.com`)

**Alternative: Manual Render Setup**

1. Click "New +" → "Web Service"
2. Connect your repository
3. Configure:
   - **Name**: `mindpath-backend`
   - **Root Directory**: `backend`
   - **Build Command**: `pip install -r requirements.txt && python -c 'import nltk; nltk.download("vader_lexicon", quiet=True)'`
   - **Start Command**: `python src/app.py`
   - **Environment**: Python 3

#### Step 3: Deploy Frontend to Vercel

**Method A: Using Vercel CLI** (Recommended)

1. Install Vercel CLI:
```bash
npm i -g vercel
```

2. Copy the Vercel configuration to frontend directory:
```bash
cp frontend-vercel.json frontend/vercel.json
```

3. Configure environment variable:
```bash
cd frontend
# Create .env.local for local testing
echo "NEXT_PUBLIC_BACKEND_URL=https://your-mindpath-backend.onrender.com" > .env.local
```

4. Deploy to Vercel:
```bash
# First time: links project to Vercel
vercel

# Production deployment
vercel --prod

# Set environment variable for production
vercel env add NEXT_PUBLIC_BACKEND_URL production
# Then paste your backend URL when prompted
```

**Method B: Via Vercel Dashboard**

1. Go to [Vercel](https://vercel.com)
2. Import your repository
3. Configure:
   - **Root Directory**: `frontend`
   - **Framework Preset**: Next.js
   - **Build Command**: `npm run build` (auto-detected)
   - **Output Directory**: `.next` (auto-detected)
   - **Install Command**: `npm install` (auto-detected)
   - **Environment Variables**:
     - Key: `NEXT_PUBLIC_BACKEND_URL`
     - Value: Your Render backend URL (e.g., `https://mindpath-backend.onrender.com`)
4. Deploy

**Method C: Using the Helper Script**

```bash
./deploy-mindpath-vercel.sh
```

This interactive script will guide you through the deployment process.

#### Step 4: Update CORS Settings

After deployment, you may need to update the backend's CORS settings to allow your Vercel frontend domain:

```python
# In backend/src/app.py
CORS(app, origins=["https://your-frontend.vercel.app"])
socketio = SocketIO(app, cors_allowed_origins=["https://your-frontend.vercel.app"])
```

### Option 2: Full Render.com Deployment

Deploy both frontend and backend to Render.com:

1. Use the `render-mindpath.yaml` configuration
2. Add a static site or web service for the frontend:

```yaml
services:
  - type: web
    name: mindpath-backend
    # ... (see render-mindpath.yaml)
  
  - type: web
    name: mindpath-frontend
    env: node
    buildCommand: "cd frontend && npm install && npm run build"
    startCommand: "cd frontend && npm start"
    envVars:
      - key: NEXT_PUBLIC_BACKEND_URL
        fromService:
          type: web
          name: mindpath-backend
          property: hostport
```

### Option 3: Railway.app Deployment

Railway supports WebSocket connections and can host both services:

1. Install Railway CLI:
```bash
npm i -g @railway/cli
```

2. Initialize Railway project:
```bash
railway init
```

3. Deploy backend:
```bash
cd backend
railway up
```

4. Deploy frontend:
```bash
cd frontend
railway up
```

5. Link services via environment variables in Railway dashboard

### Option 4: Docker Compose (Local/VPS)

For development or VPS deployment:

```bash
# From the root directory (after running mindpath-genesis.sh)
docker compose up --build
```

Access at `http://localhost:3000`

## Configuration Files

### `vercel.json`
Configures Vercel deployment for the frontend only. Points to the `frontend/` directory and sets up environment variables for backend connectivity.

### `vercel-backend.json`
⚠️ **Not recommended** - Experimental configuration for attempting to deploy the backend to Vercel. This will not work properly due to WebSocket limitations but is provided for reference.

### `render-mindpath.yaml`
Render.com Blueprint configuration for deploying the backend service with WebSocket support.

## Environment Variables

### Frontend (Vercel)
- `NEXT_PUBLIC_BACKEND_URL`: URL of the deployed backend (e.g., `https://mindpath-backend.onrender.com`)

### Backend (Render/Railway)
- `PORT`: Port number (default: 5008, Render may override)
- `PYTHON_VERSION`: Python version (3.9.0+)

## Troubleshooting

### Frontend can't connect to backend
1. Check that `NEXT_PUBLIC_BACKEND_URL` is set correctly
2. Verify backend CORS settings allow your frontend domain
3. Ensure backend is running and accessible

### Backend WebSocket errors
1. Confirm the hosting platform supports WebSockets
2. Check that Flask-SocketIO is properly installed
3. Verify NLTK VADER lexicon is downloaded during build

### CORS issues
Update backend `app.py`:
```python
CORS(app, origins=["https://your-frontend-domain.vercel.app", "http://localhost:3000"])
socketio = SocketIO(app, cors_allowed_origins=["https://your-frontend-domain.vercel.app", "http://localhost:3000"])
```

## Security Considerations

For production deployment:

1. **Restrict CORS origins** to your specific domains
2. **Add authentication** to protect the WebSocket endpoints
3. **Rate limit** PoCC submissions to prevent abuse
4. **Use HTTPS** for all communications
5. **Implement proper session management**
6. **Add input validation** and sanitization
7. **Monitor and log** suspicious activities

## Next Steps

After deployment:

1. Test the connection flow from frontend to backend
2. Monitor backend logs for WebSocket connections
3. Test sentiment analysis and reward calculations
4. Implement authentication and user management
5. Add database persistence (replace in-memory DB)
6. Set up monitoring and alerts

## Support

For issues with:
- **Vercel**: See [Vercel Documentation](https://vercel.com/docs)
- **Render.com**: See [Render Documentation](https://render.com/docs)
- **Railway**: See [Railway Documentation](https://docs.railway.app)
- **Mindpath Application**: Refer to the repository README and code comments

## Additional Resources

- [Vercel Next.js Deployment](https://vercel.com/docs/frameworks/nextjs)
- [Render Python Apps](https://render.com/docs/deploy-flask)
- [Flask-SocketIO Documentation](https://flask-socketio.readthedocs.io/)
- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
